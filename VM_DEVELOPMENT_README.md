# Разработка на VM

## Обзор

Этот документ описывает процесс разработки и тестирования сервиса прямо на VM с последующей синхронизацией изменений через Git.

## Преимущества разработки на VM

- **Быстрое тестирование** - изменения сразу доступны в продакшн-подобной среде
- **Реальные данные** - работа с реальными базами данных и сервисами
- **Масштабируемость** - тестирование на реальной инфраструктуре
- **Синхронизация** - автоматическая синхронизация между локальной машиной и VM

## Архитектура разработки

```
Локальная машина ←→ Git ←→ VM
     ↓              ↓      ↓
  Редактирование  Коммит  Тестирование
```

## Настройка окружения

### 1. Подключение к VM

```bash
ssh -l dankartsev 84.201.146.125
cd bot-project
```

### 2. Запуск сервисов разработки

```bash
# Остановка продакшн сервисов
pm2 stop bot-admin
pm2 stop bot-backend

# Запуск в режиме разработки
cd packages/operator-admin
npm run dev  # Запускается на порту 3001

cd ../backend
npm run dev  # Запускается на порту 3000
```

### 3. Проверка статуса

```bash
# Проверка портов
ss -tlnp | grep -E ':(3000|3001)'

# Проверка процессов
pm2 list
```

## Рабочий процесс разработки

### Этап 1: Разработка на VM

1. **Подключение к VM**
   ```bash
   ssh -l dankartsev 84.201.146.125
   cd bot-project
   ```

2. **Запуск разработки**
   ```bash
   cd packages/operator-admin
   npm run dev
   ```

3. **Внесение изменений**
   - Редактируйте файлы прямо на VM
   - Тестируйте изменения в браузере
   - Используйте `http://84.201.146.125:3001` для панели операторов

### Этап 2: Синхронизация изменений

1. **Коммит изменений на VM**
   ```bash
   cd ~/bot-project
   ./sync-dev.sh
   ```

2. **Получение изменений локально**
   ```bash
   # На локальной машине
   .\scripts\sync-from-vm.ps1
   ```

### Этап 3: Локальная доработка

1. **Внесение дополнительных изменений**
   - Работайте с кодом локально
   - Используйте локальные инструменты разработки

2. **Отправка изменений на VM**
   ```bash
   .\scripts\sync-to-vm.ps1
   ```

## Скрипты синхронизации

### На VM: `sync-dev.sh`

Автоматически коммитит изменения и показывает статус репозитория.

```bash
cd ~/bot-project
./sync-dev.sh
```

### Локально: `sync-from-vm.ps1`

Получает изменения с VM и обновляет локальный репозиторий.

```powershell
.\scripts\sync-from-vm.ps1
```

### Локально: `sync-to-vm.ps1`

Отправляет локальные изменения на VM.

```powershell
.\scripts\sync-to-vm.ps1
```

## Структура портов

| Сервис | Порт | Описание |
|---------|------|----------|
| Backend | 3000 | API сервер |
| Admin Panel | 3001 | Панель операторов |
| Database | 5432 | PostgreSQL |
| Redis | 6379 | Кэш и очереди |

## Мониторинг и логи

### PM2 процессы

```bash
# Список процессов
pm2 list

# Логи процесса
pm2 logs bot-admin
pm2 logs bot-backend

# Мониторинг в реальном времени
pm2 monit
```

### Docker контейнеры

```bash
# Статус контейнеров
docker-compose ps

# Логи контейнеров
docker-compose logs -f
```

## Отладка

### Hot Reload

- **Frontend**: Next.js автоматически перезагружает страницу при изменениях
- **Backend**: Используйте `nodemon` для автоматической перезагрузки

### Логи разработки

```bash
# Логи Next.js
cd packages/operator-admin
npm run dev

# Логи backend
cd packages/backend
npm run dev
```

## Рекомендации

### 1. Частота синхронизации

- Синхронизируйтесь после каждого значимого изменения
- Не накапливайте много изменений перед синхронизацией
- Используйте понятные сообщения коммитов

### 2. Безопасность

- Не коммитьте чувствительные данные (пароли, ключи API)
- Используйте `.env` файлы для конфигурации
- Проверяйте `.gitignore` перед коммитом

### 3. Производительность

- Останавливайте неиспользуемые сервисы
- Мониторьте использование ресурсов
- Очищайте логи и временные файлы

## Устранение неполадок

### Проблема: Не удается подключиться к VM

```bash
# Проверка доступности
ping 84.201.146.125

# Проверка SSH
ssh -l dankartsev 84.201.146.125
```

### Проблема: Порт занят

```bash
# Поиск процесса, использующего порт
ss -tlnp | grep :3001

# Остановка процесса
pm2 stop bot-admin
```

### Проблема: Конфликты Git

```bash
# На VM
cd ~/bot-project
git status
git pull origin main

# Локально
git pull origin main
git status
```

## Заключение

Разработка на VM обеспечивает быстрое тестирование и развертывание изменений. Используйте предоставленные скрипты для автоматизации процесса синхронизации и следуйте рекомендациям для эффективной работы.
