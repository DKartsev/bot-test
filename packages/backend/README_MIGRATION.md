# Backend - –ú–∏–≥—Ä–∞—Ü–∏—è –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

## üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
```bash
npm run fix-issues
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
npm run check-db
npm run setup-db
```

### 3. –ó–∞–ø—É—Å–∫ backend
```bash
npm run dev
```

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
**–ü—Ä–∏—á–∏–Ω–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª .env –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–†–µ—à–µ–Ω–∏–µ**:
1. –§–∞–π–ª .env —É–∂–µ —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ VM 158.160.169.147
3. CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è localhost:3001 –∏ VM:3001

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—à–∏–±–∫–∞ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —á–∞—Ç–æ–≤
**–ü—Ä–∏—á–∏–Ω–∞**: –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã

**–†–µ—à–µ–Ω–∏–µ**:
1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ VM
2. –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `npm run setup-db`
3. ChatRepository –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏

## üåê –ú–∏–≥—Ä–∞—Ü–∏—è —Å Supabase –Ω–∞ PostgreSQL

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:
- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VM
- ‚úÖ –£–¥–æ–±—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–ª–∞—Ç—ã –∑–∞ Supabase

### –≠—Ç–∞–ø—ã –º–∏–≥—Ä–∞—Ü–∏–∏:

#### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL –Ω–∞ VM
```bash
# –ù–∞ VM 158.160.169.147
ssh -l dankartsev 158.160.169.147

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏
chmod +x install-postgresql-vm.sh
./install-postgresql-vm.sh
```

#### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
npm run migrate-from-supabase
```

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞
```bash
npm run check-db
npm run dev
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
scripts/
‚îú‚îÄ‚îÄ check-db.ts              # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
‚îú‚îÄ‚îÄ setup-db.ts              # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ —Å—Ö–µ–º—ã
‚îú‚îÄ‚îÄ migrate-from-supabase.ts # –ú–∏–≥—Ä–∞—Ü–∏—è –∏–∑ Supabase
‚îú‚îÄ‚îÄ fix-issues.ts            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ install-postgresql-vm.sh # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL –Ω–∞ VM
‚îî‚îÄ‚îÄ quick-start-vm.sh        # –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –Ω–∞ VM
```

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
- **users** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram
- **support_chats** - —á–∞—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- **messages** - —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö
- **operators** - –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

### –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ò–Ω–¥–µ–∫—Å—ã –ø–æ user_id, status, operator_id
- –ò–Ω–¥–µ–∫—Å—ã –ø–æ chat_id, timestamp
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ telegram_id

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
```bash
# –°–±–æ—Ä–∫–∞
npm run build

# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run dev

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
npm run type-check

# –õ–∏–Ω—Ç–∏–Ω–≥
npm run lint
npm run lint:fix
```

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
npm run check-db

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î
npm run setup-db

# –ú–∏–≥—Ä–∞—Ü–∏—è –∏–∑ Supabase
npm run migrate-from-supabase
```

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è VM:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
./install-postgresql-vm.sh

# –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫
./quick-start-vm.sh
```

## üîê –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env):
```bash
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (VM)
DB_HOST=158.160.169.147
DB_PORT=5432
DB_NAME=support_db
DB_USER=postgres
DB_PASSWORD=postgres

# CORS
CORS_ORIGIN=http://localhost:3001,http://158.160.169.147:3001

# JWT
JWT_SECRET=dev_jwt_secret_key_here_minimum_32_characters_long
```

### Supabase (–¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏):
```bash
SUPABASE_HOST=your-project.supabase.co
SUPABASE_USER=postgres
SUPABASE_PASSWORD=your-supabase-password
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Health Check:
```bash
curl http://localhost:3000/health
```

### API Endpoints:
```bash
# –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∞—Ç–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç JWT)
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     http://localhost:3000/api/chats
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏:
- –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: `logs/app.log`
- –õ–æ–≥–∏ PostgreSQL: `/var/log/postgresql/` (–Ω–∞ VM)

### –ú–µ—Ç—Ä–∏–∫–∏:
- Health endpoint: `/health`
- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—Å—Ç—Ä–æ–µ–Ω—ã

## üö® –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å VM: `ping 158.160.169.147`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å PostgreSQL –Ω–∞ VM
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env

### –û—à–∏–±–∫–∞ CORS:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS_ORIGIN –≤ .env
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ frontend –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—Ç—É
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend

### –û—à–∏–±–∫–∞ JWT:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ JWT_SECRET (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ

## üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å VM

### –ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
git add .
git commit -m "Fix backend issues and migrate to PostgreSQL"
git push origin main

# –ù–∞ VM
git pull origin main
npm install
npm run build
npm run setup-db
npm run start
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) - –î–µ—Ç–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫
- [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md) - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏
- [POSTGRESQL_SETUP.md](./POSTGRESQL_SETUP.md) - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PostgreSQL –Ω–∞ VM** –∏—Å–ø–æ–ª—å–∑—É—è `install-postgresql-vm.sh`
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ Supabase
3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é** —á–µ—Ä–µ–∑ `npm run migrate-from-supabase`
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ backend** —á–µ—Ä–µ–∑ `npm run dev`
5. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ —Å VM** —á–µ—Ä–µ–∑ git

## üí° –°–æ–≤–µ—Ç—ã

- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `npm run fix-issues` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ `npm run check-db`
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ VM –¥–ª—è production, –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ VM –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º
